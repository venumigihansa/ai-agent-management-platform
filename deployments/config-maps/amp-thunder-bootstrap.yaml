/*
 * Copyright (c) 2026, WSO2 LLC. (https://www.wso2.com).
 * 
 * WSO2 LLC. licenses this file to you under the Apache License,
 * Version 2.0 (the "License"); you may not use this file except
 * in compliance with the License.
 * You may obtain a copy of the License at
 * 
 * http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */

apiVersion: v1
kind: ConfigMap
metadata:
  name: amp-thunder-bootstrap
  namespace: openchoreo-control-plane
  labels:
    app.kubernetes.io/component: thunder-bootstrap
data:
  50-amp-api-client.sh: |
    #!/bin/bash
    set -e

    AMP_API_CLIENT_ID="amp-api-client"
    AMP_API_CLIENT_SECRET="amp-api-client-secret"

    # THUNDER_API_BASE is exported by setup.sh
    log_info "Checking if application for AMP API already exists..."
    existing_apps=$(curl -k -s --max-time 10 "${THUNDER_API_BASE}/applications")

    # Extract application ID if it exists
    app_id=$(echo "$existing_apps" | grep -o "\"client_id\":\"${AMP_API_CLIENT_ID}\"[^}]*\"id\":\"[^\"]*\"\|\"id\":\"[^\"]*\"[^}]*\"client_id\":\"${AMP_API_CLIENT_ID}\"" | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)

    # Define the application payload
    APP_PAYLOAD='{
      "name": "AMP API Client",
      "description": "Client application for AMP API access",
      "auth_flow_graph_id": "auth_flow_config_basic",
      "inbound_auth_config": [
        {
          "type": "oauth2",
          "config": {
            "client_id": "'"${AMP_API_CLIENT_ID}"'",
            "client_secret": "'"${AMP_API_CLIENT_SECRET}"'",
            "grant_types": [
              "client_credentials"
            ],
            "token_endpoint_auth_method": "client_secret_post",
            "pkce_required": false,
            "public_client": false,
            "token": {
              "access_token": {
                "validity_period": 3600
              }
            }
          }
        }
      ]
    }'

    if echo "$existing_apps" | grep -q "\"client_id\":\"${AMP_API_CLIENT_ID}\""; then
      log_info "AMP API Client application already exists (id: $app_id), updating..."
      curl -k --location -X PUT "${THUNDER_API_BASE}/applications/$app_id" \
        --header 'Content-Type: application/json' \
        --data "$APP_PAYLOAD" \
        --fail-with-body \
        --max-time 30 \
        --retry 3 \
        --retry-delay 5

      log_info "AMP API Client application updated successfully"
    else
      log_info "AMP API Client application does not exist, creating..."
      curl -k --location "${THUNDER_API_BASE}/applications" \
        --header 'Content-Type: application/json' \
        --data "$APP_PAYLOAD" \
        --fail-with-body \
        --max-time 30 \
        --retry 3 \
        --retry-delay 5

      log_info "AMP API Client application created successfully"
    fi

  51-amp-console-app.sh: |
    #!/bin/bash
    set -e

    AMP_CONSOLE_CLIENT_ID="amp-console-client"
    AMP_CONSOLE_CLIENT_SECRET="amp-console-client-secret"
    REDIRECT_URI="http://localhost:3000/login"

    log_info "Checking if application 'AMP Console' already exists..."
    existing_apps=$(curl -k -s --max-time 10 "${THUNDER_API_BASE}/applications")

    # Extract application ID if it exists
    app_id=$(echo "$existing_apps" | grep -o "\"client_id\":\"${AMP_CONSOLE_CLIENT_ID}\"[^}]*\"id\":\"[^\"]*\"\|\"id\":\"[^\"]*\"[^}]*\"client_id\":\"${AMP_CONSOLE_CLIENT_ID}\"" |  grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)    

    # Define the application payload
    APP_PAYLOAD='{
      "name": "AMP Console",
      "description": "AMP Console Application",
      "auth_flow_graph_id": "auth_flow_config_basic",
      "inbound_auth_config": [
        {
          "type": "oauth2",
          "config": {
            "client_id": "'"${AMP_CONSOLE_CLIENT_ID}"'",
            "client_secret": "'"${AMP_CONSOLE_CLIENT_SECRET}"'",
            "redirect_uris": [
              "'"${REDIRECT_URI}"'"
            ],
            "grant_types": [
              "authorization_code",
              "client_credentials"
            ],
            "response_types": [
              "code"
            ],
            "token_endpoint_auth_method": "client_secret_post",
            "pkce_required": false,
            "public_client": false,
            "token": {
              "issuer": "thunder",
              "access_token": {
                "validity_period": 3600,
                "user_attributes": [
                  "given_name",
                  "family_name",
                  "username",
                  "groups"
                ]
              },
              "id_token": {
                "validity_period": 3600,
                "user_attributes": [
                  "given_name",
                  "family_name",
                  "username",
                  "groups"
                ],
                "scope_claims": {
                  "groups": [
                    "groups"
                  ],
                  "profile": [
                    "username",
                    "given_name",
                    "family_name",
                    "picture"
                  ]
                }
              }
            }
          }
        }
      ]
    }'

    if echo "$existing_apps" | grep -q "\"client_id\":\"${AMP_CONSOLE_CLIENT_ID}\""; then
      log_info "Application 'AMP Console' already exists (id: $app_id), updating..."
      curl -k --location -X PUT "${THUNDER_API_BASE}/applications/$app_id" \
        --header 'Content-Type: application/json' \
        --data "$APP_PAYLOAD" \
        --fail-with-body \
        --max-time 30 \
        --retry 3 \
        --retry-delay 5

      log_info "Application updated successfully"
    else
      log_info "Application does not exist, creating default application..."
      curl -k --location "${THUNDER_API_BASE}/applications" \
        --header 'Content-Type: application/json' \
        --data "$APP_PAYLOAD" \
        --fail-with-body \
        --max-time 30 \
        --retry 3 \
        --retry-delay 5

      log_info "Default application created successfully"
    fi

  52-user-schema-and-users.sh: |
    #!/bin/bash
    set -e

    # First, create the default OU if it doesn't exist
    log_info "Checking if default organization unit exists..."
    if ! curl -k -s --max-time 10 "${THUNDER_API_BASE}/organization-units" | grep -q '"handle":"default"'; then
      log_info "Creating default organization unit..."
      curl -k --location "${THUNDER_API_BASE}/organization-units" \
        --header 'Content-Type: application/json' \
        --header 'Accept: application/json' \
        --data '{
          "name": "Default",
          "handle": "default",
          "description": "Default organizational unit"
        }' \
        --fail-with-body \
        --max-time 30 \
        --retry 3 \
        --retry-delay 5
      log_info "Default organization unit created successfully"
    else
      log_info "Default organization unit already exists"
    fi

    # Get the organization unit ID
    ORG_UNIT_ID=$(curl -k -s --max-time 10 "${THUNDER_API_BASE}/organization-units" | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)
    log_info "Using organization unit ID: $ORG_UNIT_ID"

    log_info "Checking if user schema 'engineer' already exists..."
    existing_schemas=$(curl -k -s --max-time 10 "${THUNDER_API_BASE}/user-schemas")

    if echo "$existing_schemas" | grep -q '"name":"engineer"'; then
      log_info "User schema 'engineer' already exists, skipping creation"
    else
      log_info "User schema does not exist, creating user schema..."
      curl -k --location "${THUNDER_API_BASE}/user-schemas" \
        --header 'accept: application/json' \
        --header 'Content-Type: application/json' \
        --data "{
          \"name\": \"engineer\",
          \"ouId\": \"$ORG_UNIT_ID\",
          \"allowSelfRegistration\": true,
          \"schema\": {
            \"username\": {
              \"type\": \"string\",
              \"required\": true
            },
            \"password\": {
              \"type\": \"string\",
              \"required\": true
            },
            \"given_name\": {
              \"type\": \"string\"
            },
            \"family_name\": {
              \"type\": \"string\"
            },
            \"groups\": {
              \"type\": \"array\",
              \"items\": {\"type\": \"string\"}
            }
          }
        }" \
        --fail-with-body \
        --max-time 30 \
        --retry 3 \
        --retry-delay 5

      log_info "User schema created successfully"
    fi

    # Create default users
    USERNAME="amp-admin@wso2.com"
    PASSWORD="Amp-Admin@wso2.com"
    GIVEN_NAME="AMP"
    FAMILY_NAME="Admin"
    GROUPS='["admin"]'
    log_info "Checking if user '${USERNAME}' already exists..."
    existing_users=$(curl -k -s --max-time 10 "${THUNDER_API_BASE}/users")

    if echo "$existing_users" | grep -q "\"username\":\"${USERNAME}\""; then
      log_info "User '${USERNAME}' already exists, skipping creation"
    else
      log_info "User does not exist, creating user '${USERNAME}'..."
      curl -k --location "${THUNDER_API_BASE}/users" \
        --header 'accept: application/json' \
        --header 'Content-Type: application/json' \
        --data "{
          \"type\": \"engineer\",
          \"organizationUnit\": \"$ORG_UNIT_ID\",
          \"attributes\": {
            \"username\": \"${USERNAME}\",
            \"password\": \"${PASSWORD}\",
            \"given_name\": \"${GIVEN_NAME}\",
            \"family_name\": \"${FAMILY_NAME}\",
            \"groups\": ${GROUPS}
          }
        }" \
        --fail-with-body \
        --max-time 30 \
        --retry 3 \
        --retry-delay 5

      log_info "User '${USERNAME}' created successfully"
